# Backlog V1 — MVP Slice (Vertical)

Этот документ описывает **MVP Slice** для проверки гипотезы вовлечения в диалог.
Мы следуем методологии **Vertical Slicing**: каждая P0 задача добавляет ценность
пользователю и работает end-to-end (Frontend + Backend + State).

Источник правды: `one-thread-pitch-romance-chat-v1.0.md` (Pitch) и
`story-map-one-thread.md`.

**Цель слайса:** Провести "Cheapest tests" на 10-20 парах и замерить воронку.
**Основная метрика:** % пар, успешно прошедших 5 шагов (Session Completion
Rate).

## Definition of Ready (DoR)

- **USER-CENTRIC**: Написана как User Story.
- **VERTICAL**: Включает в себя UI, логику и данные.
- **TESTABLE AC**: 3–6 критериев (Да/Нет).
- **METRIC**: Указано, какую метрику из Pitch мы проверяем/собираем.
- **BLOCKED BY**: Явные зависимости.
- **ESTIMATE**: S/M/L.

## Backlog spine (walking skeleton как задачи)

- [x] P0-01 Выбрать роль и сохранить выбор
- [x] P0-02 Встать в очередь и видеть ожидание
- [x] P0-03 Получить мэтч и увидеть “Партнёр найден”
- [x] P0-04 Стартовать сессию только после обоих
- [ ] P0-05 Пройти шаг диалога с видео/баблом/кнопками
- [ ] P0-06 Сделать выбор и синхронно перейти дальше
- [ ] P0-09 Восстановиться после перезагрузки
- [ ] P0-12 Иметь базовые логи событий
- [ ] P0-13 Открыться по публичному URL

---

## P0 — must-have (V1 не существует без этого)

### P0-01

**Title:** выбрать роль и сохранить выбор

**Story:** “Как пользователь (М/Ж), я хочу выбрать пол, чтобы система могла
подобрать мне пару противоположного пола”.

**Hypothesis/Metric:** Entrance Rate (кто не отвалился на выборе).

**Acceptance Criteria (AC):**

- [x] При входе показывается экран с 2 кнопками: "Мужчина" и "Женщина".
- [x] Выбор сохраняется в локальном состоянии и отправляется на сервер
      (`POST /role`).
- [x] После выбора происходит переход на экран ожидания.
- [x] Повторный заход показывает сохраненное состояние (не спрашивает заново).

**Notes:**

- UI: максимально простой, акцент на кнопках.
- Tech: создать сессию (deviceId/fingerprint).

**Metadata:**

- Blocking stories: нет.
- Estimate: S
- Tag: Core Flow
- Priority: P0

### P0-02

**Title:** встать в очередь и видеть ожидание

**Story:** “Как пользователь, я хочу видеть, что я в очереди, чтобы понимать,
что система ищет мне партнёра”.

**Hypothesis/Metric:** Retention in Queue (сколько ждут до отвала).

**Acceptance Criteria (AC):**

- [x] Отправляется запрос `POST /queue/join`.
- [x] Экран показывает статус "Ищем партнера...".
- [x] Реализован polling или WS соединение для ожидания мэтча.
- [x] Нельзя перейти дальше, пока сервер не пришлет event `partner_found`.
- [x] Есть кнопка «Отмена», которая возвращает к выбору роли.

**Notes:**

- UI: спиннер или пульс.
- Tech: простая in-memory очередь на бэкенде.

**Metadata:**

- Blocking stories: P0-01.
- Estimate: S
- Tag: Core Flow
- Priority: P0

### P0-03

**Title:** получить мэтч и увидеть партнёра найденным

**Story:** “Как пользователь, я хочу мгновенно узнать, что партнер найден, чтобы
приготовиться к диалогу”.

**Hypothesis/Metric:** Search Rate (время ожидания).

**Acceptance Criteria (AC):**

- [x] Сервер соединяет М и Ж из очереди (FIFO).
- [x] Оба клиента получают событие `partner_found` (через WS/SSE или Polling).
- [x] Экран меняется на "Партнёр найден!" без перезагрузки страницы.
- [x] Есть кнопка «Отмена», которая возвращает к выбору роли.

**Notes:**

- Tech: `session_id` теперь общий для двух пользователей.

**Metadata:**

- Blocking stories: P0-02.
- Estimate: M
- Tag: Core Flow
- Priority: P0

### P0-04

**Title:** стартовать только после подтверждения обоих (Handshake)

**Story:** “Как пользователь, я хочу подтвердить готовность, чтобы мы начали
диалог синхронно”.

**Hypothesis/Metric:** Start Rate (успешные старты / всего мэтчей).

**Acceptance Criteria (AC):**

- [x] На экране мэтча есть кнопка "Начать".
- [x] Нажатие отправляет `POST /session/start`.
- [x] Статус меняется на "Жду партнера", если второй еще не нажал.
- [x] Когда оба нажали — сервер шлет `session_started` и первый шаг.

**Notes:**

- Важно: защищает от AFK пользователей в очереди.

**Metadata:**

- Blocking stories: P0-03.
- Estimate: M
- Tag: Core Flow
- Priority: P0

### P0-05

**Title:** показать шаг диалога с видео, баблом и кнопками

**Story:** “Как пользователь, я хочу видеть контекст (видео) и варианты
действий, чтобы совершить ход”.

**Hypothesis/Metric:** Step Conversion (отвалы на конкретных шагах).

**Acceptance Criteria (AC):**

- [ ] Клиент рендерит `<video>` (loop, muted, playsinline) из URL текущего шага.
- [ ] Показывается текстовый "бабл" (контекст шага).
- [ ] Активный игрок видит кнопки выбора ответа.
- [ ] Пассивный игрок видит статус "Партнер выбирает..." и скрытые кнопки.

**Notes:**

- Tech: состояние `current_step` и `turn_user_id` приходит с бэкенда.
- UI: Важна скорость загрузки видео (preload - см. P1, здесь базово).

**Metadata:**

- Blocking stories: P0-04.
- Estimate: M
- Tag: Core Flow
- Priority: P0

### P0-06

**Title:** выбрать ответ и синхронно перейти дальше

**Story:** “Как пользователь, я хочу выбрать реплику, чтобы сюжет развивался”.

**Hypothesis/Metric:** Interaction Time (время на раздумья).

**Acceptance Criteria (AC):**

- [ ] Нажатие кнопки отправляет `POST /session/step/answer`.
- [ ] Оба клиента получают обновление `step_advanced`.
- [ ] У обоих отображается бабл с выбранной репликой.
- [ ] У партнера (на кого смотрели) видео меняется на новое (реакция или след.
      шаг).
- [ ] У того, кто выбирал, видео остается (или меняется по сценарию).

**Notes:**

- Core mechanic: выбор влияет на видео партнера.

**Metadata:**

- Blocking stories: P0-05.
- Estimate: M
- Tag: Core Flow
- Priority: P0

### P0-07

**Title:** завершить сессию и вернуться в очередь

**Story:** “Как пользователь, я хочу увидеть завершение сессии и вернуться в
очередь, чтобы начать новый диалог”.

**Acceptance Criteria (AC):**

- [ ] После завершения показывается экран «Сессия завершена».
- [ ] Кнопка «В очередь» возвращает в состояние ожидания.
- [ ] Состояние шага сбрасывается при возврате в очередь.

**Notes:**

- UI мок — экран завершения.

**Metadata:**

- Blocking stories: P0-06.
- Estimate: S
- Tag: Build
- Priority: P0

### P0-08

**Title:** завершать сессию по тайм-ауту (Hard Limit)

**Story:** “Как система, я хочу завершать зависшие сессии, чтобы освобождать
ресурсы”.

**Hypothesis/Metric:** Timeout Rate (скучно или тех. проблема).

**Acceptance Criteria (AC):**

- [ ] Сервер запускает таймер на 60 сек activity timeout.
- [ ] При истечении таймера сервер шлет событие `session_ended` {reason:
      timeout}.
- [ ] Клиенты показывают экран "Время вышло".

**Notes:**

- Warnings (предупреждения) вынесены в P1 для упрощения MVP Slice, здесь только
  Hard Limit.

**Metadata:**

- Blocking stories: P0-06.
- Estimate: S
- Tag: Reliability
- Priority: P0

### P0-09

**Title:** восстановиться после перезагрузки

**Story:** “Как пользователь, я хочу вернуться в своё текущее состояние после
перезагрузки, чтобы не терять прогресс”.

**Acceptance Criteria (AC):**

- [ ] Перезагрузка в очереди возвращает пользователя в очередь без дубликата.
- [ ] Перезагрузка во время сессии возвращает пользователя в актуальный шаг.
- [ ] Если сессия завершилась в фоне, пользователь видит экран завершения.

**Notes:**

- Требует сохранения состояния сессии.

**Metadata:**

- Blocking stories: P0-06.
- Estimate: M
- Tag: Fix
- Priority: P0

### P0-10

**Title:** редактировать сценарий без кода (Config-driven)

**Story:** “Как сценарист, я хочу управлять сюжетом через файлы, чтобы быстро
менять контент для тестов”.

**Hypothesis/Metric:** N/A (Internal Enablement).

**Acceptance Criteria (AC):**

- [ ] Бэкенд читает сценарий из `story.json` (или yaml) при старте.
- [ ] Структура файла описывает id шага, видео (м/ж), варианты ответов,
      переходы.
- [ ] Видео файлы лежат в `/public/assets`.
- [ ] Изменение JSON обновляет логику (требует рестарта сервиса, но не
      перекомпиляции кода).

**Notes:**

- Никакой админки. Только файл.

**Metadata:**

- Blocking stories: нет.
- Estimate: M
- Tag: Enablement
- Priority: P0

### P0-11

**Title:** получать обновления состояния без обновления страницы

**Story:** “Как пользователь, я хочу видеть изменения статуса сразу, чтобы не
обновить страницу вручную”.

**Acceptance Criteria (AC):**

- [ ] Мэтч, старт и переходы шагов приходят автоматически (без refresh).
- [ ] Изменения состояния видны у обоих клиентов в течение 2 сек.
- [ ] При потере соединения пользователь видит понятное состояние (например,
      «подключаемся…»).

**Notes:**

- Реал-тайм канал (WebSocket/SSE) — реализации не навязываем.

**Metadata:**

- Blocking stories: P0-03.
- Estimate: M
- Tag: Build
- Priority: P0

### P0-12

**Title:** логировать ключевые события сессии (Analytics)

**Story:** “Как аналитик, я хочу видеть raw events в консоли/файле, чтобы
построить воронку вручную”.

**Hypothesis/Metric:** Funnel Analysis.

**Acceptance Criteria (AC):**

- [ ] Middleware логирует события в structured JSON format.
- [ ] Список событий: `selected_gender`, `queued`, `partner_found`,
      `start_pressed`, `session_started`, `choice_made`, `step_advanced`,
      `timeout_warn`, `timeout_end`, `disconnect`, `session_end`.
- [ ] В каждом событии есть `timestamp` и `session_id`.

**Notes:**

- Это "Cheapest tests" инфраструктура.

**Metadata:**

- Blocking stories: P0-06.
- Estimate: S
- Tag: Analytics
- Priority: P0

### P0-13

**Title:** открыть прототип по публичному URL

**Story:** “Как тестер, я хочу открыть прототип по публичному URL с телефона,
чтобы пройти сценарий в реальных условиях”.

**Acceptance Criteria (AC):**

- [ ] Прототип доступен по HTTPS URL.
- [ ] URL открывается в мобильном браузере и ведёт на экран выбора роли.
- [ ] Два разных устройства могут пройти один сценарий одновременно.

**Notes:**

- Деплой в минимальное окружение (dev/staging).

**Metadata:**

- Blocking stories: P0-01.
- Estimate: M
- Tag: Build
- Priority: P0

---

## P1 — делает V1 приемлемым

### P1-01

**Title:** пройти 5 шагов сценария

**Story:** “Как пользователь, я хочу пройти несколько шагов диалога, чтобы опыт
ощущался как разговор, а не демо”.

**Acceptance Criteria (AC):**

- [ ] Сценарий содержит минимум 5 шагов.
- [ ] Ходы чередуются между участниками.
- [ ] После 5-го шага сессия завершается корректно.

**Notes:**

- Требует готового сценария/видео.

**Metadata:**

- Blocking stories: P0-06, P0-10.
- Estimate: M
- Tag: Build
- Priority: P1

### P1-02

**Title:** завершать сессию при дисконнекте партнёра

**Story:** “Как пользователь, я хочу получить понятное завершение при отвале
партнёра, чтобы не зависнуть”.

**Acceptance Criteria (AC):**

- [ ] Если партнёр отключился, второй видит сообщение о завершении.
- [ ] Пользователь может сразу вернуться в очередь.
- [ ] Сессия закрывается и не продолжает слать обновления.

**Notes:**

- Явный сценарий disconnect.

**Metadata:**

- Blocking stories: P0-06.
- Estimate: M
- Tag: Fix
- Priority: P1

### P1-03

**Title:** показывать ошибку и давать повторить действие

**Story:** “Как пользователь, я хочу увидеть ошибку и повторить действие, чтобы
не терять сессию из-за сбоя”.

**Acceptance Criteria (AC):**

- [ ] При ошибке join/start/answer показывается сообщение и кнопка «Повторить».
- [ ] Повтор не создаёт дубликатов (очереди/сессии).
- [ ] После успешного повтора пользователь возвращается в правильное состояние.

**Notes:**

- Минимальная обработка ошибок сети/сервера.

**Metadata:**

- Blocking stories: P0-02, P0-04, P0-06.
- Estimate: M
- Tag: Fix
- Priority: P1

### P1-04

**Title:** ускорить переходы между шагами **Story:** “Как пользователь, я хочу,
чтобы переходы между шагами были быстрыми, чтобы не терять ощущение диалога”.

**Acceptance Criteria (AC):**

- [ ] Предзагрузка видео следующего шага выполняется в фоне.
- [ ] Переход шага занимает ≤ 2 сек на тестовом наборе.
- [ ] Если предзагрузка не удалась, показывается безопасный фолбэк (без
      зависания).

**Notes:**

- Тестовый набор видео фиксируется заранее.

**Metadata:**

- Blocking stories: P0-05, P0-06.
- Estimate: M
- Tag: Polish
- Priority: P1

### P1-05

**Title:** показать таймер/предупреждение о тайм-ауте

**Story:** “Как пользователь, я хочу знать, что меня сейчас выкинет, чтобы
успеть сделать ход”.

**Hypothesis/Metric:** Timeout Rescue Rate.

**Acceptance Criteria (AC):**

- [ ] За 30 сек до конца тайм-аута сервер шлет `timeout_warning`.
- [ ] UI показывает обратный отсчет или алерт.
- [ ] Любое действие пользователя сбрасывает таймер.

**Notes:**

- Улучшение для P0-08.

**Metadata:**

- Blocking stories: P0-08.
- Estimate: S
- Tag: UX/Polish
- Priority: P1

### P1-06

**Title:** валидировать сценарий на старте (Fail Fast)

**Story:** “Как разработчик, я хочу, чтобы сервис падал при старте, если видео
нет, чтобы не чинить баги в рантайме”.

**Acceptance Criteria (AC):**

- [ ] При старте парсится `story.json`.
- [ ] Проверяется наличие всех видео-файлов из JSON-а в папке ассетов.
- [ ] Проверяется целостность графа (нет ссылок на несуществующие ID).
- [ ] Ошибка выводится в лог и процесс завершается с exit code 1.

**Metadata:**

- Blocking stories: P0-10.
- Estimate: S
- Tag: Ops
- Priority: P1

---

## P2 — улучшения/расширения (почти всё можно выкинуть)

### P2-01

**Title:** показывать прогресс сценария

**Story:** “Как пользователь, я хочу видеть номер шага, чтобы понимать, где я в
истории”.

**Acceptance Criteria (AC):**

- [ ] На экране шага отображается прогресс (например, 2/5).
- [ ] Прогресс синхронен у обоих участников.
- [ ] При завершении прогресс исчезает.

**Notes:**

- UI мок — индикатор прогресса.

**Metadata:**

- Blocking stories: P1-01.
- Estimate: S
- Tag: Polish
- Priority: P2

### P2-02

**Title:** добавить экран вступления перед выбором роли **Story:** “Как
пользователь, я хочу короткое вступление, чтобы понимать, что это за опыт”.

**Acceptance Criteria (AC):**

- [ ] Перед выбором роли есть отдельный экран с описанием.
- [ ] Кнопка «Начать» переводит к выбору роли.
- [ ] Возврат назад не сбивает выбранную роль, если она уже есть.

**Notes:**

- Контент вступления — 2–3 предложения.

**Metadata:**

- Blocking stories: P0-01.
- Estimate: S
- Tag: Polish
- Priority: P2

### P2-03

**Title:** добавить возрастной гейт 18+ **Story:** “Как продукт, мы хотим
подтвердить 18+, чтобы снизить риск неподходящей аудитории”.

**Acceptance Criteria (AC):**

- [ ] Перед началом показывается экран подтверждения 18+.
- [ ] Без подтверждения пользователь не может продолжить.
- [ ] Подтверждение сохраняется в сессии.

**Notes:**

- В V1 можно игнорировать.

**Metadata:**

- Blocking stories: P0-01.
- Estimate: S
- Tag: Risk
- Priority: P2

### P2-04

**Title:** экспортировать результаты теста в CSV **Story:** “Как команда тестов,
мы хотим выгрузить результаты сессий, чтобы анализировать их вне системы”.

**Acceptance Criteria (AC):**

- [ ] Есть простой экспорт по кнопке или URL.
- [ ] В CSV есть session_id, даты, исход (завершено/тайм-аут/дисконнект).
- [ ] Экспорт не требует ручной обработки логов.

**Notes:**

- Только для внутреннего использования.

**Metadata:**

- Blocking stories: P0-12.
- Estimate: M
- Tag: Build
- Priority: P2

### P2-05

**Title:** добавить жалобу на партнёра

**Story:** “Как пользователь, я хочу пожаловаться на партнёра, чтобы иметь выход
при неприятном опыте”.

**Acceptance Criteria (AC):**

- [ ] На экране сессии есть кнопка «Пожаловаться».
- [ ] Нажатие завершает сессию и фиксирует событие в логах.
- [ ] Пользователь возвращается в очередь.

**Notes:**

- Только логирование, без модерации.

**Metadata:**

- Blocking stories: P0-12.
- Estimate: M
- Tag: Risk
- Priority: P2
