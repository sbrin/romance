# Development Guide: Romance‑Chat Backend

Этот документ определяет технологический стек, архитектурные принципы и
методологию разработки для проекта Romance‑Chat. Основная цель — быстрая
доставка (2 недели) при сохранении стабильности и масштабируемости.

---

## 1. Технологический Стек

- **Runtime:** Node.js (v20+)
- **Language:** TypeScript (Strict mode)
- **Framework:** [Fastify](https://www.fastify.io/) — высокая
  производительность, встроенная валидация схем.
- **Real‑time:** [Socket.io](https://socket.io/) — управление сессиями,
  "комнаты", авто-реконнект.
- **Validation:** [Zod](https://zod.dev/) — Single Source of Truth для типов и
  валидации.
- **State Machine:** Простая реализация FSM (Finite State Machine) для
  управления сессиями.
- **Deployment:** [Railway.app](https://railway.app/) — для быстрого деплоя и
  поддержки WebSocket.

---

## 2. Архитектурные Принципы

### A. Vertical Slicing (Feature‑First)

Мы не разделяем код по техническим слоям (Controllers/Services). Мы разделяем
его по **бизнес-фичам**. _Каждая фича живет в своей папке и содержит всё
необходимое (роуты, логику, типы)._

**Структура проекта:**

```text
/src
  /core            # Shared: настройки логгера, обертки socket.io, плагины fastify
  /modules
    /matching      # Логика очереди и поиска пары
    /session       # Управление жизненным циклом сессии (Start/End/Sync)
    /content       # Загрузчик и парсер story.json (сценарий)
  /shared          # Глобальные типы, Zod-схемы, утилиты
  app.ts           # Точка входа
```

### B. Server as a Source of Truth (FSM)

Клиент — это «глупый» терминал. Вся логика переходов находится на сервере.

- Сессия проходит через строгие состояния: `WAITING_FOR_PARTNER` → `MATCHED` →
  `WAITING_FOR_START` → `ACTIVE` → `FINISHED`.
- Действия пользователя (выбор ответа, нажатие Start) разрешены только в
  определенных состояниях. Это предотвращает баги, когда "кто-то нажал дважды
  или не вовремя".

### C. Fail Fast & Guardrails (Защита от ошибок)

1. **Zod Everywhere:** Любой объект извне (JSON сценарий, запрос от клиента)
   проверяется Zod-схемой. Если данные невалидны — сервер падает (при старте)
   или выдает ошибку (в рантайме) немедленно.
2. **Type Safety:** `any` запрещен. Все события Socket.io должны быть
   типизированы.
3. **No DB for V1:** Весь стейт хранится в оперативной памяти (In-memory Maps).

---

## 3. Definition of Done (DoD)

Задача считается выполненной, если:

0. Весь код покрыт юнит-тестами.
1. Код написан на TypeScript без `any`.
2. Входные данные валидируются через Zod.
3. Функционал проверен вручную (двумя игроками).
4. Событие залогировано (JSON формат для аналитики).
